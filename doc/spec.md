2次元コンボリューションアクセラレータ Sting仕様書
=====

# 概要
本仕様書はFPGA向け、Deep Learningで使用する2次元コンボリューションアクセラレータ Sting について記載した物である。
StingはZynq上で動作し、Deep Learningのコンボリューションと、それに続くLeakyRELU、Batch Normalizationの処理を行う。
Stingを使うことで、ARM CPU単体で実行するよりも高速にコンボリューションの計算を実行できる。

# 機能

Stingはレイヤーの計算を実行できる。

- 2次元コンボリューション
- LeakyRELU
- Batch Normalization

入力データのx方向の最大サイズは512、y方向は分割機能を使うことで無制限。入力チャネル数、フィルター数（出力チャネル数）の最大は2048。

Zynqで使用するIPコアとしては以下の機能を持つ。
- AXI_HP 1port 入力データリード用
- AXI_GP 2port レジスタR/W用、重みデータリード用
- AXI_ACP 1port 出力データR/W用
- 割り込み信号 1本
- リセット 1本
- CLK 1本

# ブロック図
Sitngのブロック図を以下に示す。

<img src="blk.png">

各ブロックは以下の機能を持つ。

| ブロック名|サブブロック名|機能|
|:----|:----|:----|
| STING\_TOP| - | TOP階層 |
| CC2\_REG\_IF| - | レジスタI/F|
| CC2\_CONTROL|- | 全体制御|
| |CC2\_INTC| 割り込み|
| CC2\_AXI\_RD\_INPUT |-|入力データのリード|
| CC2\_AXI\_RD\_WEIGHT |-|重みデータのリード|
| CC2\_AXI\_RW\_OUTPUT |-|出力データのR/W |
| CC2\_DSP3x3 |-|　3x3のフィルター計算|
| CC2\_CONV | - | コンボリューションの実行|
|| CC2\_BIAS | BIAS項の加算|
|| CC2\_BN |バッチノーマライゼーションの計算 |
|| CC2\_LRERU |LeakyRELUの計算 |

各ブロックの詳細はブロック仕様にて記載する。

# 動作説明
StingはCPUからのレジスタライトで起動する。高速化のために、出力データの作業メモリとしてZynq APUのL2キャッシュを想定しており、出力データのサイズにより動作を変える必要がある。L2キャッシュが512Kバイトなので、主力データがそれ以上の場合は分割実行が必要になる。Stingが分割実行をするかどうかは、実行モードによって指定する。

実行モード
- 通常モード　出力データが512Kバイト以下で使用。一回の起動で全ての計算が終了する。
- 分割モード　出力データが512Kバイト以下になるように分割して起動する。分割数と同じだけの起動が必要である。

まずは変数の定義をした後、通常モードと、分割モードでの計算順序について記述する。

## 変数定義
Stingでは計算の変数について以下の定義を使用する。変数名はコキュートスの出力Cソースと対応している。

<img src="val.png">

| 変数名 | 意味 |
|:----|:----|
|n | 入力データのチャネル数。入力データがインプットレイヤーの出力の時、n=3(RGB)となる。それ以外の時は、前のレイヤーのフィルター数と同じである。 |
|f | フィルターの数、出力データのチャネル数を示す。 |
|x | 入力データのwidth方向の変数。左端を0に取る。 |
|y | 入力データのheight方向の変数。上端を0に取る。 |

## 通常モード動作
通常モードでは一回の起動で全ての処理を完了する。

はじめにf=0について全ての計算を行う。
<img src="seq_n1.png">  

次にf=1について全ての計算を行う。
<img src="seq_n2.png">

以下全ての計算が終了するまでfの値を増やしていく。

## 分割モード動作時

はじめにf=0について、分割した部分の計算を行う。分割の単位はレジスタで指定する。
<img src="seq_d1.png">

分割した箇所についてf=1の計算を行う。
<img src="seq_d2.png">

fの最後まで計算すると割り込みが入り、stingは動作を完了する。
<img src="seq_d3.png">

新しくレジスタを設定し、次の分割の単位の計算を開始させる。（f=0)
<img src="seq_d4.png">

今まで同様にf=1から 最後まで順に処理を行い、最後に割り込みを発生させ動作を終了する。
<img src="seq_d5.png">

# ブロック仕様

## STING\_TOP
### 機能一覧
STINGのTOP階層。

### 入出力一覧



## CC2\_REG\_IF
## CC2\_CONTROL
## CC2\_AXI\_RD\_INPUT
## CC2\_AXI\_RD\_WEIGHT
## CC2\_AXI\_RW\_OUTPUT
## CC2\_DSP3x3
## CC2\_CONV

# レジスタ一覧

# リファレンス